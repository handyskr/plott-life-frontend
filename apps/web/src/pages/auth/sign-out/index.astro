---
import Layout from '@layouts/Layout.astro';
import Header from '@components/template/Header.astro';

if (!Astro.locals.isLoggedIn) {
  return Astro.redirect('/auth/login');
}
---
<Layout>
  <Header
    slot='header'
    showBackIcon={true}
  />
  <div class="max-w-lg mx-auto h-full flex flex-col justify-between py-4">
    <div class='flex flex-col gap-8'>
      <div class='flex flex-col gap-2 px-6'>
        <h1 class="text-2xl font-bold text-gray-900">회원 탈퇴하기</h1>
        <p class="text-base text-gray-600">
          회원 탈퇴를 진행하시기 전에 <br />
          아래의 유의사항을 꼭! 확인해주세요
        </>
      </div>
      <div class='bg-gray-50 p-6'>
        <h2 class='text-base text-gray-900'>유의 사항</h2>
        <ul class='ml-4 list-disc mt-4 text-sm text-gray-600'>
          <li>회원정보 및 서비스 이용 기록 데이터는 파기되어 복구할 수 없습니다.</li>
          <li>탈퇴한 아이디로는 재가입이 불가능하며, 아이디 및 데이터는 복구할 수 없습니다.</li>
          <li>현재 진행 중인 계약이 있는 경우, 계약을 종료하신 후 탈퇴하실 수 있습니다.</li>
          <li>다른 사용자에게 보낸 채팅 메시지, 계약 정보 등 일부 정보는 계속 남아있을 수 있습니다. </li>
        </ul>
      </div>
    </div>
    <div class='flex flex-col gap-8 px-6 pb-(--bait)'>
      <label class="label gap-4">
        <input
          name="agree"
          class="checkbox checkbox-neutral w-6 h-6"
          type="checkbox"
        />
        <p class="text-sm text-black">
          유의사항을 확인하였으며, 탈퇴에 동의합니다.
        </p>
      </label>
      <button id="sign-out" class="btn btn-neutral btn-block btn-lg" disabled>
        탈퇴하기
      </button>
    </div>
  </div>
</Layout>
<script>
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";

  const button = document.getElementById('sign-out') as HTMLButtonElement;
  const checkbox = document.querySelector('input[name="agree"]') as HTMLInputElement;

  checkbox?.addEventListener('change', (e: any) => {
      button.disabled = !e.target.checked;
  });
  button?.addEventListener("click", async (e: any) => {
    const { error } = await actions.signOut();
    if (error) {
      alert("탈퇴 처리 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
      return;
    }

    await navigate("/auth/sign-out/success");
  })
</script>
